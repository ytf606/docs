<!DOCTYPE html>

<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">


		<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Merriweather:400,400italic,700,700italic|Open+Sans:400,400italic,600,600italic,700,700italic|Inconsolata:400,700">
		<link rel="stylesheet" href="/docs/css/main.css">
		<link rel="apple-touch-icon" href="/docs/images/apple-touch-icon.png">
		<link rel="icon" type="image/png" href="/docs/images/touch-icon.png" sizes="192x192">
		<link rel="icon" type="image/png" href="/docs/images/favicon.png">

		
	</head>

	<body>
		<header>
			<h1>
				<a href="/docs/"><img src="/docs/images/emblem.svg" width="40" height="40" alt="ATD文档中心 logo"></a>
				ATD文档中心
				<button type="button" class="open-nav" id="open-nav"></button>
			</h1>
			<!--
			<form action="/docs/search/" method="get">
				<input type="text" name="q" id="search-input" placeholder="搜索" autofocus>
				<input type="submit" value="search" style="display: none;">
			</form>
		-->
			<nav class="full-navigation">
				<ul>
					<li class="nav-item top-level ">
						
						<a href="/docs/">ATD新手入门文档</a>
					</li>
				</ul>

				<ul>
					
					
						<li class="nav-item "><a href="/docs/%E9%AB%98%E7%BA%A7%E8%AE%A1%E7%AE%97%E6%A8%A1%E5%BC%8F%E7%9A%84%E7%AD%96%E7%95%A5%E8%AE%BE%E7%BD%AE/">高级计算模式的策略设置</a></li>
					
						<li class="nav-item "><a href="/docs/%E9%AB%98%E7%BA%A7%E6%90%9C%E7%B4%A2%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3/">高级搜索说明文档</a></li>
					
						<li class="nav-item "><a href="/docs/%E5%87%A0%E7%A7%8D%E6%8E%A8%E6%97%A5%E5%BF%97%E6%96%B9%E5%BC%8F%E4%BB%8B%E7%BB%8D/">几种推日志方式介绍</a></li>
					
						<li class="nav-item "><a href="/docs/%E5%8F%AF%E7%BC%96%E7%A8%8B%E5%AF%B9%E6%8A%97-%E9%AB%98%E7%BA%A7%E8%A7%84%E5%88%99/">可编程对抗-高级规则</a></li>
					
						<li class="nav-item "><a href="/docs/%E5%8F%AF%E7%BC%96%E7%A8%8B%E5%AF%B9%E6%8A%97%E6%A8%A1%E5%9E%8B%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3/">可编程对抗模型说明文档</a></li>
					
						<li class="nav-item "><a href="/docs/%E8%BD%AE%E8%AF%A2%E5%91%A8%E6%9C%9F%E4%BD%BF%E7%94%A8%E6%96%87%E6%A1%A3/">轮询周期使用文档</a></li>
					
						<li class="nav-item "><a href="/docs/%E5%86%85%E7%BD%91%E8%87%AA%E5%AE%9A%E4%B9%89%E5%A4%84%E7%90%86%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3/">内网自定义处理接口文档</a></li>
					
						<li class="nav-item current"><a href="/docs/%E6%97%A5%E5%BF%97%E9%85%8D%E7%BD%AE%E6%96%87%E6%A1%A3/">日志配置文档</a></li>
					
						<li class="nav-item "><a href="/docs/%E7%AE%97%E6%B3%95%E6%A8%A1%E5%9E%8B%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3/">算法模型开发文档</a></li>
					
						<li class="nav-item "><a href="/docs/%E5%BE%AE%E4%BF%A1%E5%91%8A%E8%AD%A6%E5%AF%B9%E6%8E%A5%E6%93%8D%E4%BD%9C%E6%96%87%E6%A1%A3/">微信告警对接操作文档</a></li>
					
						<li class="nav-item "><a href="/docs/%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83%E8%87%AA%E5%8A%A8%E8%B0%83%E6%95%B4%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3/">运行环境自动调整接口文档</a></li>
					
						<li class="nav-item "><a href="/docs/%E6%89%A7%E8%A1%8C%E5%8A%A8%E4%BD%9C%E4%BD%BF%E7%94%A8%E6%96%87%E6%A1%A3/">执行动作使用文档</a></li>
					
						<li class="nav-item "><a href="/docs/%E6%99%BA%E8%83%BD%E6%97%A5%E5%BF%97%E8%A7%A3%E6%9E%90/">智能日志解析</a></li>
					
						<li class="nav-item "><a href="/docs/%E8%B5%84%E4%BA%A7%E5%8F%91%E7%8E%B0/">资产发现</a></li>
					
						<li class="nav-item "><a href="/docs/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%A4%84%E7%90%86%E6%96%B9%E5%BC%8F%E6%8E%A5%E5%8F%A3%E5%BC%80%E5%8F%91%E6%96%87%E6%A1%A3/">自定义处理方式接口开发文档</a></li>
					
						<li class="nav-item "><a href="/docs/FAQ/">FAQ</a></li>
					
				</ul>

			</nav>
		</header>

		<section class="main">
			<div class="page-header">
				<h2>ATD文档中心</h2>
				<h3>日志配置文档</h3>
			</div>
			<article class="content">
				<h2 id="概述">概述</h2>

<blockquote>
  <p>1、在部署完ATD之后，您需要进行日志配置操作，以便ATD可以解析您的日志，进而进行威胁分析。</p>
</blockquote>

<blockquote>
  <p>2、ATD支持<strong>智能解析</strong>和<strong>手动解析</strong>两种方式</p>
</blockquote>

<p><strong>智能解析</strong>只需要提供原始日志，ATD系统会自动根据日志格式进行自动化匹配出符合条件的多条结果，根据匹配度自上而下排列，选择最准确的一条结果作为解析方式即可。智能解析适用于系统日志的自动化解析，目前支持的日志类型列表<a href="https://github.com/yunjuhe/atd/blob/master/%E6%99%BA%E8%83%BD%E6%97%A5%E5%BF%97%E8%A7%A3%E6%9E%90.md">在此</a></p>

<p><strong>手动解析</strong>需要提供原始日志，然后根据日志类型选择合适的规则进行递归式解析，直到解析出需要的结果为止。
说明：由于手动解析牵涉较多，下面将重点介绍手动解析方式的流程方式。下图即是两种解析方式，默认是智能解析，只需要把原始日志填入，然后点击解析即可。</p>

<blockquote>
  <p>3、日志对接分为三步：</p>
</blockquote>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>（1）日志格式配置，即根据原始日志进行日志类型匹配和字段映射设置，以便ATD可以成功解析您的日志；

（2）日志对接配置，即配置TopicName、Zookeeper地址等，以便ATD知道从哪里可以获取到您推送的日志；

（3）推日志，在完成日志配置后，您需要将日志推送到Kafka相应的TopicName中。【注意】请勿将不同格式的域名日志推到同一个TopicName下，否则ATD将无法完成日志解析且不能进行威胁分析。
</code></pre></div></div>

<p><img src="/docs/images/log/parse10.png" alt="智能解析" /></p>

<h2 id="步骤一手动解析日志配置">步骤一：手动解析日志配置</h2>

<p>目前，ATD支持四种日志类型：</p>

<p>1、logformat</p>

<p>2、JSON</p>

<p>3、正则表达式</p>

<p>4、分隔符</p>

<p>请根据您实际的日志类型，添加相应的日志格式，不同日志类型的配置如下：<br /></p>

<h3 id="1logformat">1、logformat</h3>

<p><strong>（1）日志样例</strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>124.239.189.15 - [2016-07-16T15:56:04+08:00] 2ab80c0cf.yunlian.io "GET /adf/ad.php?abc=select+*+from+information_schema+where+1&amp;testlogintest=test HTTP/1.1" 0.011 401 173 201 "-" "curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.15.3 zlib/1.2.3 libidn/1.18 libssh2/1.4.2" "-"
</code></pre></div></div>
<p><strong>（2）log_format字段</strong></p>

<p>对于纯文本类型的日志，只需要填写一条原始日志及相应的log_format即可，ATD规定的log_format字段名称如下表所示：</p>

<table>
  <thead>
    <tr>
      <th>字段名</th>
      <th>解释</th>
      <th>默认值</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>*remote_addr</td>
      <td>客户端IP地址</td>
      <td>-</td>
    </tr>
    <tr>
      <td>*request_uri</td>
      <td>请求的uri</td>
      <td>-</td>
    </tr>
    <tr>
      <td>*http_host</td>
      <td>请求地址（域名）</td>
      <td>必填</td>
    </tr>
    <tr>
      <td>http_x_forwarded_for</td>
      <td>反向客户端IP地址</td>
      <td>-</td>
    </tr>
    <tr>
      <td>time_local</td>
      <td>通用日志格式下的本地时间</td>
      <td>-</td>
    </tr>
    <tr>
      <td>status</td>
      <td>请求返回的状态码</td>
      <td>200</td>
    </tr>
    <tr>
      <td>hostname</td>
      <td>日志来源</td>
      <td>-</td>
    </tr>
    <tr>
      <td>remote_user</td>
      <td>客户端用户名称</td>
      <td>-</td>
    </tr>
    <tr>
      <td>method</td>
      <td>http请求方法</td>
      <td>GET</td>
    </tr>
    <tr>
      <td>body_bytes_sent</td>
      <td>发送给客户端的字节数，不包括响应头的大小</td>
      <td>0</td>
    </tr>
    <tr>
      <td>bytes_sent</td>
      <td>发送给客户端的总字节数</td>
      <td>-</td>
    </tr>
    <tr>
      <td>http_referer</td>
      <td>记录从哪个页面链接访问过来的</td>
      <td>-</td>
    </tr>
    <tr>
      <td>http_user_agent</td>
      <td>记录客户端浏览器相关信息</td>
      <td>chrome</td>
    </tr>
    <tr>
      <td>request_length</td>
      <td>请求的长度（包括请求行，请求头和请求正文）</td>
      <td>0</td>
    </tr>
    <tr>
      <td>request_time</td>
      <td>请求处理时间，单位为秒，精度毫秒</td>
      <td>0</td>
    </tr>
    <tr>
      <td>upstream_status</td>
      <td>upstream返回的状态码信息</td>
      <td>-</td>
    </tr>
    <tr>
      <td>upstream_addr</td>
      <td>后端upstream地址，真正提供服务的主机地址</td>
      <td>-</td>
    </tr>
    <tr>
      <td>upstream_response_time</td>
      <td>upstream响应时间</td>
      <td>0</td>
    </tr>
  </tbody>
</table>

<p><strong>（3）log_format格式要求</strong></p>

<blockquote>
  <ul>
    <li>如果您的日志是文本格式，请务必使用ATD指定的字段名称定义log_format，否则ATD将无法完成日志解析；</li>
    <li>字段名以$为前缀，例如：$remote_addr</li>
    <li>含有“*”字符的字段必须指定的字段；</li>
    <li>如果您的日志中没有http_host，您可以在配置页面上设置http_host的默认值；</li>
    <li>log_format中的字段必须按顺序与原始日志中的字段一一对应，如果您的日志中包含上述字段之外的字段，可自定义名称，如：field1</li>
  </ul>
</blockquote>

<p><strong>（4）配置示例</strong></p>

<p>原始日志：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>124.239.189.15 - [2016-07-16T15:56:04+08:00] 2ab80c0cf.yunlian.io "GET /adf/ad.php?abc=select+*+from+information_schema+where+1&amp;testlogintest=test HTTP/1.1" 0.011 401 173 201 "-" "curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.15.3 zlib/1.2.3 libidn/1.18 libssh2/1.4.2" "-"
</code></pre></div></div>

<p>log_format：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$remote_addr $remote_user [$time_local] $http_host "$method $request_uri $http" $request_time $status $body_bytes_sent $request_length "$http_referer" "$http_user_agent" "$http_x_forwarded_for"
</code></pre></div></div>

<p><img src="/docs/images/log/parse2.png" alt="logformat解析" /></p>

<h3 id="2-json">2、 JSON</h3>

<p><strong>（1）日志样例</strong></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="nl">"remote_addr"</span><span class="p">:</span><span class="s2">"124.239.189.115"</span><span class="p">,</span><span class="nl">"time_local"</span><span class="p">:</span><span class="s2">"2017-06-29T15:25:59+08:00"</span><span class="p">,</span><span class="nl">"scheme"</span><span class="p">:</span><span class="s2">"http"</span><span class="p">,</span><span class="nl">"http_host"</span><span class="p">:</span><span class="s2">"yunlian.io"</span><span class="p">,</span><span class="nl">"method"</span><span class="p">:</span><span class="s2">"GET"</span><span class="p">,</span><span class="nl">"request_uri"</span><span class="p">:</span><span class="s2">"/adf/logining/ad.php?abc=test"</span><span class="p">,</span><span class="nl">"request_time"</span><span class="p">:</span><span class="s2">"1.187"</span><span class="p">,</span><span class="nl">"status"</span><span class="p">:</span><span class="s2">"200"</span><span class="p">,</span><span class="nl">"upstream_addr"</span><span class="p">:</span><span class="s2">"192.168.11.207"</span><span class="p">,</span><span class="nl">"upstream_status"</span><span class="p">:</span><span class="s2">"200"</span><span class="p">,</span><span class="nl">"upstream_response_time"</span><span class="p">:</span><span class="s2">"1.187"</span><span class="p">,</span><span class="nl">"request_length"</span><span class="p">:</span><span class="s2">"2054"</span><span class="p">,</span><span class="nl">"body_bytes_sent"</span><span class="p">:</span><span class="s2">"1181"</span><span class="p">,</span><span class="nl">"http_referer"</span><span class="p">:</span><span class="s2">"http://2ab80c0cf.yunlian.io/123456.html"</span><span class="p">,</span><span class="nl">"http_user_agent"</span><span class="p">:</span><span class="s2">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/45.0.2454.101 Safari/537.36"</span><span class="p">,</span><span class="nl">"http_x_forwarded_for"</span><span class="p">:</span><span class="s2">"124.239.189.115"</span><span class="p">,</span><span class="nl">"hostname"</span><span class="p">:</span><span class="s2">"node001131"</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><strong>（2）配置示例</strong></p>

<blockquote>
  <p>如果您的日志如上样例所示，您只需上传一条原始日志，并在界面中设置映射关系即可。</p>
</blockquote>

<p><strong>（3）注意事项</strong></p>

<blockquote>
  <p>如果是JSON格式数据，请不要格式化数据，也即是原始日志是一行完整的JSON格式数据，而不是多行格式化的数据。</p>
</blockquote>

<p><img src="/docs/images/log/parse3.png" alt="json解析" /></p>

<h3 id="3正则表达式">3、正则表达式</h3>
<p><strong>（1）日志样例</strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Jan 31 15:39:54 xm11-112 sshd[4187]: Received disconnect from 172.18.14.184 port 62750:11: disconnected by user
</code></pre></div></div>

<p><strong>（2）配置示例</strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(?&lt;date&gt;\w{3}\s+\d{1,2}\s\d\d:\d\d:\d\d)\s(?&lt;dst&gt;\S+)\s+(?&lt;pid&gt;[^:]*):\s+(?&lt;message&gt;.*)
</code></pre></div></div>

<p><img src="/docs/images/log/parse4.png" alt="正则解析" /></p>

<h3 id="4分隔符">4、分隔符</h3>
<p><strong>（1）日志样例</strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>18:21:02 [pid:123] [MOC]ip=1.1.1.1,host=bjp123,message=loginsuccess
</code></pre></div></div>

<p><strong>（2）配置示例</strong></p>

<p>分隔符解析方式首先进行字段分割，字段分割分为：”,”、”|”、”:”、”&amp;”、”;”、”自定义”方式，采用分隔符解析字段分隔符必选。其次根据实际情况是否对字段分隔符解析进行K-V形式解析，K-V形式解析包括：”=”、”:”、”自定义”。无论是分隔符或K-V都可以多段并行解析，也即是可以同时存在多个字段分隔符或K-V分隔符。
针对上述日志样例，字段分隔符采用”,”，K-V分隔符采用”=”，如下图所示：
<img src="/docs/images/log/parse5.png" alt="分隔符解析" /></p>

<h2 id="步骤二日志对接配置">步骤二：日志对接配置</h2>
<blockquote>
  <p>在成功完成日志格式配置后，您可以对某个日志格式进行对接配置，选择使用ATD的Kafka或是您私有的Kafka，在选择了您私有的Kafka后，您需要设置TopicName、Zookeeper地址或Kafka地址。</p>
</blockquote>

<h2 id="步骤三推日志">步骤三：推日志</h2>
<blockquote>
  <p>1、在完成日志配置后，您需要将日志推送到Kafka相应的TopicName中。
【注意】请勿将不同格式的域名日志推到同一个TopicName下，否则ATD将无法完成日志解析且不能进行威胁分析。
2、在进行推日志操作时，您可以根据每个日志格式后对应的文档说明来进行推日志操作。</p>
</blockquote>

<h3 id="四种推日志方式介绍">四种推日志方式介绍</h3>
<p>ATD支持多种给Kafka推送日志的方式，每种方式有推荐使用场景，以下是几种推送方式优缺点介绍：</p>
<h4 id="1优先推荐kafkacat推送方式">1、优先推荐Kafkacat推送方式</h4>
<h5 id="优势">优势：</h5>
<p>由C语言开发，资源消耗少。</p>

<h5 id="劣势">劣势:</h5>
<p>（1）推送日志文件的名称固定，有做日志切割的日志文件在切割完成后必须保持文件名不变，如nginx_access.log。
（2）不支持修改日志中的字段，只支持简单的过滤操作。</p>

<h4 id="2rsyslog推送方式">2、Rsyslog推送方式</h4>
<h5 id="优势-1">优势：</h5>
<p>由C语言开发，资源消耗少，支持通配符及新产生文件内容的推送，如/data0/logs/*.log。</p>

<h5 id="劣势-1">劣势：</h5>
<p>（1）需要升级rsyslog以及安装rsyslog-kafka插件进行推送，可能需要下载依赖包。
（2）不支持修改日志中的字段，只支持简单的过滤操作</p>

<h4 id="3filebeat推送方式">3、Filebeat推送方式</h4>

<h5 id="优势-2">优势：</h5>
<p>由GO语言开发，相比于Java语言开发的logstash资源消耗少一些，可以过滤及简单的修改日志中的字段，支持通配符及新产生文件内容的推送，依赖包较少。</p>

<h5 id="劣势-2">劣势：</h5>
<p>（1）相比于C语言开发的工具如rsyslog、kafkacat资源消耗更多一些。
（2）不能精确修改日志中的字段。</p>

<h4 id="4logstash推送方式">4、Logstash推送方式</h4>

<h5 id="优势-3">优势：</h5>
<p>由Java语言开发，可精确修改日志中的字段，支持通配符及新产生文件内容的推送，依赖包较少。</p>

<h5 id="劣势-3">劣势：</h5>
<p>资源消耗比另外几种推送工具高。</p>

			</article>
		</section>

		<script>
			document.getElementById("open-nav").addEventListener("click", function () {
				document.body.classList.toggle("nav-open");
			});
		</script>
	</body>
</html>
